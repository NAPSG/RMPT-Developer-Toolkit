// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/array","dojo/Deferred","jimu/portalUtils"],function(g,m,q){function n(a){return g.some(r,function(b){return-1<a.search(b)})}function p(a){return g.some(t,function(b){return-1<a.search(b)})}function u(a){var b=new m;if(a){a=[].concat(a.operationalLayers,a.baseMap&&a.baseMap.baseMapLayers);var e=[],f={},c;g.forEach(a,function(a){var b,d;a&&a.url&&(b=a.url,d=document.createElement("a"),d.href=b,b=n(d.host),d=p(d.host),b||d)&&(f[a.url]?(c=f[a.url],c.title=c.title+", "+(a.title||a.name)):
(c={sourceUrl:a.url,title:a.title||a.name,premium:b,consumeCredits:d,useProxy:!1},e.push(c),f[a.url]=c))});b.resolve(e)}else b.resolve([]);return b}var r=[/traffic\w*\.arcgis\.com/i,/elevation\w*\.arcgis\.com/i,/geoenrich\w*\.arcgis\.com/i,/hydro\w*\.arcgis\.com/i,/naip\w*\.arcgis\.com/i,/livefeeds\w*\.arcgis\.com/i,/demographics\w*\.arcgis\.com/i,/landscape\w*\.arcgis\.com/i,/historical\w*\.arcgis\.com/i,/earthobs\w*\.arcgis\.com/i],t=[/demographics\w*\.arcgis\.com/i,/geoenrich\w*\.arcgis\.com/i,
/route\w*\.arcgis\.com/i,/logistics\w*\.arcgis\.com/i,/analysis\w*\.arcgis\.com/i,/elevation\w*\.arcgis\.com/i],k={queryForSecureServicesInMap:function(a,b){try{return q.getPortal(a).getItemData(b).then(function(a){return u(a)},function(){return[]})}catch(e){return a=new m,a.resolve([]),a}},isLimitedProxy:function(a){return a?!isNaN(a.hitsPerInterval)&&!isNaN(a.intervalSeconds)&&0<a.intervalSeconds&&0<a.hitsPerInterval:!1},findProxy:function(a,b){var e=k.isLimitedProxy(b),f;a=a||[];b=b||{};g.some(a,
function(a){if(a.sourceUrl===b.sourceUrl&&!1!==a.proxied&&a.proxyId&&a.proxyUrl){var c=!1;e&&a.hitsPerInterval===b.hitsPerInterval&&a.intervalSeconds===b.intervalSeconds?c=!0:e||k.isLimitedProxy(a)||(c=!0);c&&(f=a);return c}});return f},urlExists:function(a,b){return g.some(a.proxies,function(a){return a.sourceUrl===b&&!1!==a.proxied})},createProxy:function(a,b,e,f){var c,g,h,d=new m,l={};c=n(b);g=p(b);(h=k.findProxy(a.proxies,{sourceUrl:b,hitsPerInterval:e,intervalSeconds:f}))?(h.premium=c,h.consumeCredits=
g,d.resolve(h)):(l.sourceUrl=b,k.isLimitedProxy({hitsPerInterval:e,intervalSeconds:f})&&(l.hitsPerInterval=e,l.intervalSeconds=f),a.createProxies([l]).then(function(a){(h=k.findProxy(a,{sourceUrl:b,hitsPerInterval:e,intervalSeconds:f}))?(h.premium=c,h.consumeCredits=g,d.resolve(h)):d.reject("create proxy failed.")}).otherwise(function(a){d.reject(a)}));return d}};k.isPremium=n;k.consumesCredits=p;return k});