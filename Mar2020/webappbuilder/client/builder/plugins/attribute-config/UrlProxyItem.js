// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/Evented","./AppProxyUtil"],function(a,e,c,f,d){a=a([f],{appProxyManager:null,title:"",sourceUrl:"",proxyUrl:"",proxyId:"",premium:!0,consumeCredits:!1,hitsPerInterval:0,intervalSeconds:0,constructor:function(b){c.mixin(this,b);this.premium=d.isPremium(this.sourceUrl);this.consumeCredits=d.consumesCredits(this.sourceUrl)},createProxy:function(){if(this.premium||this.consumeCredits)if(d.urlExists(this.appProxyManager,this.sourceUrl))this.emit("processError",
this.nls.alreadyProxied);else{this._startProcess();try{d.createProxy(this.appProxyManager,this.sourceUrl,this.hitsPerInterval,this.intervalSeconds).then(c.hitch(this,function(b){this.proxyUrl=b.proxyUrl;this.proxyId=b.proxyId;this.useProxy=!0;this.premium=b.premium;this.consumeCredits=b.consumeCredits;this._stopProcess();this.emit("proxyCreated",{sourceUrl:this.sourceUrl,proxyUrl:this.proxyUrl,proxyId:this.proxyId,hitsPerInterval:this.hitsPerInterval,intervalSeconds:this.intervalSeconds,premium:this.premium,
consumeCredits:this.consumeCredits,title:this.title,useProxy:!0})})).otherwise(c.hitch(this,function(){this._stopProcess()}))}catch(b){this.emit("processError",b),this._stopProcess()}}else this.emit("processError",this.nls.notValidPremiumUrl)},deleteProxy:function(){this._startProcess();if(this.appProxyManager&&this.proxyId)try{this.appProxyManager.deleteProxies([{proxyId:this.proxyId}]).then(c.hitch(this,function(b){var a=e.some(b,c.hitch(this,function(a){return a.sourceUrl===this.sourceUrl&&!1===
a.proxied}));a||(a=e.every(b,c.hitch(this,function(a){return a.sourceUrl!==this.sourceUrl})));a?(this.proxyId=this.proxyUrl="",this.emit("proxyDeleted",this.sourceUrl)):this.emit("processError",this.nls.deleteProxyFailed+" "+this.sourceUrl);this._stopProcess()}),c.hitch(this,function(){this.emit("processError",this.nls.deleteProxyFailed+" "+this.sourceUrl);this._stopProcess()}))}catch(b){this.emit("processError",this.nls.deleteProxyFailed+" "+this.sourceUrl),this._stopProcess()}else this.emit("processError",
this.nls.deleteProxyFailed+" "+this.sourceUrl),this._stopProcess()},_startProcess:function(){this.emit("processStart")},_stopProcess:function(){this.emit("processEnd")}});a.PROXY_CREATED="proxyCreated";a.PROCESS_START="processStart";a.PROXY_DELETED="proxyDeleted";a.PROCESS_END="processEnd";a.PROCESS_ERROR="processError";return a});